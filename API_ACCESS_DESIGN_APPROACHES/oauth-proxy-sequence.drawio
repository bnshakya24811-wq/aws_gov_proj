<mxfile host="app.diagrams.net">
  <diagram name="OAuth 2.0 Proxy Pattern Sequence" id="oauth-proxy-sequence">
    <mxGraphModel dx="1434" dy="844" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1100" pageHeight="750" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="Sequence Diagram: OAuth 2.0 Proxy Pattern (API-Managed Token)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=18;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="200" y="20" width="700" height="30" as="geometry" />
        </mxCell>
        
        <!-- Actors (Headers) -->
        <mxCell id="client-header" value="Client&#xa;(Background Job)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="60" y="70" width="130" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="apigw-header" value="API Gateway" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="260" y="70" width="120" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="lambda-header" value="Lambda" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="450" y="70" width="120" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="oauth-header" value="OAuth Server&#xa;(Cognito/Auth0)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="640" y="70" width="130" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="athena-header" value="Athena&#xa;(Lake Formation)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="840" y="70" width="130" height="60" as="geometry" />
        </mxCell>
        
        <!-- Lifelines -->
        <mxCell id="client-lifeline" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#6c8ebf;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="124.5" y="670" as="sourcePoint" />
            <mxPoint x="124.5" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="apigw-lifeline" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#d6b656;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="319.5" y="670" as="sourcePoint" />
            <mxPoint x="319.5" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="lambda-lifeline" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="509.5" y="670" as="sourcePoint" />
            <mxPoint x="509.5" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="oauth-lifeline" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#b85450;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="704.5" y="670" as="sourcePoint" />
            <mxPoint x="704.5" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="athena-lifeline" value="" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="904.5" y="670" as="sourcePoint" />
            <mxPoint x="904.5" y="130" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Message 1: Client -> API Gateway -->
        <mxCell id="msg1" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#0066CC;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="125" y="170" as="sourcePoint" />
            <mxPoint x="320" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg1-label" value="1. POST /query-oauth-proxy&#xa;{client_id, client_secret, query}" style="edgeLabel;html=1;align=center;verticalAlign=top;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="140" y="140" width="190" height="35" as="geometry" />
        </mxCell>
        
        <!-- Message 2: API Gateway -> Lambda -->
        <mxCell id="msg2" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#0066CC;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="320" y="220" as="sourcePoint" />
            <mxPoint x="510" y="220" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg2-label" value="2. Forward request" style="edgeLabel;html=1;align=center;verticalAlign=top;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="370" y="200" width="110" height="20" as="geometry" />
        </mxCell>
        
        <!-- Message 3: Lambda -> OAuth Server -->
        <mxCell id="msg3" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#CC6600;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="510" y="270" as="sourcePoint" />
            <mxPoint x="705" y="270" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg3-label" value="3. POST /oauth2/token&#xa;(client_credentials grant)" style="edgeLabel;html=1;align=center;verticalAlign=top;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="540" y="245" width="150" height="30" as="geometry" />
        </mxCell>
        
        <!-- Message 4: OAuth Server validates -->
        <mxCell id="msg4" value="" style="endArrow=block;endFill=0;html=1;strokeWidth=2;strokeColor=#666666;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="705" y="320" as="sourcePoint" />
            <mxPoint x="765" y="320" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg4-label" value="4. Verify client_secret&#xa;Determine role" style="edgeLabel;html=1;align=left;verticalAlign=top;fontSize=9;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="775" y="305" width="120" height="25" as="geometry" />
        </mxCell>
        
        <!-- Message 5: OAuth Server -> Lambda (Token) -->
        <mxCell id="msg5" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#CC6600;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="705" y="370" as="sourcePoint" />
            <mxPoint x="510" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg5-label" value="5. Signed JWT token&#xa;{access_token, expires_in}" style="edgeLabel;html=1;align=center;verticalAlign=bottom;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="540" y="375" width="150" height="30" as="geometry" />
        </mxCell>
        
        <!-- Message 6: Lambda validates JWT -->
        <mxCell id="msg6" value="" style="endArrow=block;endFill=0;html=1;strokeWidth=2;strokeColor=#666666;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="510" y="420" as="sourcePoint" />
            <mxPoint x="570" y="420" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg6-label" value="6. Validate JWT signature&#xa;Extract role from claims&#xa;Map to LF role ARN" style="edgeLabel;html=1;align=left;verticalAlign=top;fontSize=9;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="580" y="400" width="140" height="40" as="geometry" />
        </mxCell>
        
        <!-- Message 7: Lambda -> Athena -->
        <mxCell id="msg7" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#CC0000;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="510" y="480" as="sourcePoint" />
            <mxPoint x="905" y="480" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg7-label" value="7. Execute Query&#xa;(with LF role)" style="edgeLabel;html=1;align=center;verticalAlign=top;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="650" y="455" width="120" height="30" as="geometry" />
        </mxCell>
        
        <!-- Message 8: Athena -> Lambda (Results) -->
        <mxCell id="msg8" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#CC0000;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="905" y="530" as="sourcePoint" />
            <mxPoint x="510" y="530" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg8-label" value="8. Query results" style="edgeLabel;html=1;align=center;verticalAlign=bottom;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="670" y="535" width="100" height="20" as="geometry" />
        </mxCell>
        
        <!-- Message 9: Lambda -> Client -->
        <mxCell id="msg9" value="" style="endArrow=block;endFill=1;html=1;strokeWidth=2;strokeColor=#0066CC;dashed=1;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="510" y="580" as="sourcePoint" />
            <mxPoint x="125" y="580" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="msg9-label" value="9. Query results" style="edgeLabel;html=1;align=center;verticalAlign=bottom;fontSize=10;labelBackgroundColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="280" y="585" width="100" height="20" as="geometry" />
        </mxCell>
        
        <!-- Key Points Box -->
        <mxCell id="keypoints" value="✅ Client simplicity (no OAuth flow)&#xa;✅ Works with any HTTP library&#xa;✅ OAuth security benefits&#xa;✅ Individual client tracking&#xa;⚠️  API handles token management&#xa;⚠️  Secrets sent in every request" style="text;html=1;strokeColor=#d79b00;fillColor=#ffe6cc;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=10;fontFamily=Monospace;" vertex="1" parent="1">
          <mxGeometry x="60" y="620" width="320" height="100" as="geometry" />
        </mxCell>
        
        <!-- Sample Request Box -->
        <mxCell id="sample" value="curl -X POST https://api.../dev/query-oauth-proxy \&#xa;  -H 'Content-Type: application/json' \&#xa;  -d '{&#xa;    &quot;client_id&quot;: &quot;john-doe-app&quot;,&#xa;    &quot;client_secret&quot;: &quot;secret-xyz&quot;,&#xa;    &quot;query&quot;: &quot;SELECT * FROM ...&quot;&#xa;  }'" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=left;verticalAlign=top;whiteSpace=wrap;rounded=1;fontSize=9;fontFamily=Courier New;fontColor=#333333;" vertex="1" parent="1">
          <mxGeometry x="420" y="620" width="550" height="100" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
