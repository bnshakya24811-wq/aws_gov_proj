AWSTemplateFormatVersion: '2010-09-09'
Description: Master Stack - Orchestrates IAM, Glue, and Governance nested stacks

Parameters:
  TemplateS3Bucket:
    Type: String
    Description: S3 bucket containing nested stack templates
    Default: deploymen-bkt
  
  TemplateS3Prefix:
    Type: String
    Description: S3 prefix/folder for nested stack templates
    Default: lf-nested-stacks
  
  LambdaCodeS3Bucket:
    Type: String
    Description: S3 bucket containing Lambda deployment packages
    Default: deploymen-bkt
  
  Environment:
    Type: String
    Description: Environment name (dev, staging, prod)
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
  
  EnableOAuth:
    Type: String
    Description: Enable OAuth/Cognito authentication
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
  
  CognitoUserPoolId:
    Type: String
    Description: Cognito User Pool ID (deploy Cognito stack separately first)
    Default: ""
  
  CognitoAppClientId:
    Type: String
    Description: Cognito App Client ID (deploy Cognito stack separately first)
    Default: ""

Conditions:
  EnableOAuthStack: !Equals [!Ref EnableOAuth, 'true']

Resources:
  # Stack 1: IAM Stack (creates users, roles, policies)
  IAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.amazonaws.com/${TemplateS3Prefix}/iam-stack.yaml
      Parameters:
        Environment: !Ref Environment
      TimeoutInMinutes: 10
      Tags:
        - Key: StackType
          Value: IAM
        - Key: Project
          Value: LakeFormationAccessControl
        - Key: Environment
          Value: !Ref Environment

  # Stack 2: Glue Stack (creates database, bucket, crawler)
  # Depends on IAM stack for GlueCrawlerRole
  GlueStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: IAMStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.amazonaws.com/${TemplateS3Prefix}/glue-stack.yaml
      Parameters:
        Environment: !Ref Environment
        GlueCrawlerRoleArn: !GetAtt IAMStack.Outputs.GlueCrawlerRoleArn
      TimeoutInMinutes: 10
      Tags:
        - Key: StackType
          Value: Glue
        - Key: Project
          Value: LakeFormationAccessControl
        - Key: Environment
          Value: !Ref Environment

  # Stack 3: Governance Stack (creates LF tags and permissions)
  # Depends on both IAM and Glue stacks
  GovernanceStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - IAMStack
      - GlueStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.amazonaws.com/${TemplateS3Prefix}/governance-stack.yaml
      Parameters:
        Environment: !Ref Environment
        DatabaseName: !GetAtt GlueStack.Outputs.DatabaseName
        LFDevUserArn: !GetAtt IAMStack.Outputs.LFDevUserArn
        LFSuperUserArn: !GetAtt IAMStack.Outputs.LFSuperUserArn
        LFDevUserRoleArn: !GetAtt IAMStack.Outputs.LFDevUserRoleArn
        LFSuperUserRoleArn: !GetAtt IAMStack.Outputs.LFSuperUserRoleArn
        GlueCrawlerRoleArn: !GetAtt IAMStack.Outputs.GlueCrawlerRoleArn
        GlueJobRoleArn: !GetAtt IAMStack.Outputs.GlueJobRoleArn
      TimeoutInMinutes: 15
      Tags:
        - Key: StackType
          Value: Governance
        - Key: Project
          Value: LakeFormationAccessControl
        - Key: Environment
          Value: !Ref Environment

  # Stack 4: Lambda Stack (creates Lambda function for Athena queries)
  # Depends on IAM and Glue stacks
  LambdaStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - IAMStack
      - GlueStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.amazonaws.com/${TemplateS3Prefix}/lambda-stack.yaml
      Parameters:
        Environment: !Ref Environment
        LFDevUserArn: !GetAtt IAMStack.Outputs.LFDevUserRoleArn
        LFSuperUserArn: !GetAtt IAMStack.Outputs.LFSuperUserRoleArn
        APIKeyMappingTableName: !Sub lf-api-key-mappings-o-sp6-${Environment}
        DatabaseName: !GetAtt GlueStack.Outputs.DatabaseName
        LambdaCodeS3Bucket: !Ref LambdaCodeS3Bucket
        LambdaCodeS3BucketRegion: !Ref AWS::Region
        LambdaCodeS3Key: lambda/athena-query-handler.zip
        CognitoUserPoolId: !Ref CognitoUserPoolId
        CognitoAppClientId: !Ref CognitoAppClientId
      TimeoutInMinutes: 10
      Tags:
        - Key: StackType
          Value: Lambda
        - Key: Project
          Value: LakeFormationAccessControl
        - Key: Environment
          Value: !Ref Environment

  # Stack 5: API Gateway Stack (creates REST API with API keys)
  # Depends on Lambda stack
  APIStackV2:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - LambdaStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.amazonaws.com/${TemplateS3Prefix}/api-stack.yaml
      Parameters:
        Environment: !Ref Environment
        LambdaFunctionArn: !GetAtt LambdaStack.Outputs.LambdaFunctionArn
      TimeoutInMinutes: 10
      Tags:
        - Key: StackType
          Value: API
        - Key: Project
          Value: LakeFormationAccessControl
        - Key: Environment
          Value: !Ref Environment

  # Stack 6: DynamoDB Stack (creates API key mapping table)
  # Depends on API stack to get API key IDs and IAM stack for user ARNs
  DynamoDBStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - APIStackV2
      - IAMStack
    Properties:
      TemplateURL: !Sub https://${TemplateS3Bucket}.s3.amazonaws.com/${TemplateS3Prefix}/dynamodb-stack.yaml
      Parameters:
        Environment: !Ref Environment
        DevUserAPIKeyId: !GetAtt APIStackV2.Outputs.DevUserAPIKeyId
        SuperUserAPIKeyId: !GetAtt APIStackV2.Outputs.SuperUserAPIKeyId
        LFDevUserRoleArn: !GetAtt IAMStack.Outputs.LFDevUserRoleArn
        LFSuperUserRoleArn: !GetAtt IAMStack.Outputs.LFSuperUserRoleArn
      TimeoutInMinutes: 10
      Tags:
        - Key: StackType
          Value: DynamoDB
        - Key: Project
          Value: LakeFormationAccessControl
        - Key: Environment
          Value: !Ref Environment

Outputs:
  # IAM Outputs
  LFDevUserArn:
    Description: ARN of the Dev User
    Value: !GetAtt IAMStack.Outputs.LFDevUserArn

  LFSuperUserArn:
    Description: ARN of the Super User
    Value: !GetAtt IAMStack.Outputs.LFSuperUserArn

  LFDevUserAccessKeyId:
    Description: Access Key ID for Dev User
    Value: !GetAtt IAMStack.Outputs.LFDevUserAccessKeyId

  LFDevUserSecretAccessKey:
    Description: Secret Access Key for Dev User (SENSITIVE)
    Value: !GetAtt IAMStack.Outputs.LFDevUserSecretAccessKey

  LFSuperUserAccessKeyId:
    Description: Access Key ID for Super User
    Value: !GetAtt IAMStack.Outputs.LFSuperUserAccessKeyId

  LFSuperUserSecretAccessKey:
    Description: Secret Access Key for Super User (SENSITIVE)
    Value: !GetAtt IAMStack.Outputs.LFSuperUserSecretAccessKey

  GlueCrawlerRoleArn:
    Description: ARN of the Glue Crawler Role
    Value: !GetAtt IAMStack.Outputs.GlueCrawlerRoleArn

  GlueJobRoleArn:
    Description: ARN of the Glue Job Role
    Value: !GetAtt IAMStack.Outputs.GlueJobRoleArn

  # Glue Outputs
  DatabaseName:
    Description: Name of the Glue Database
    Value: !GetAtt GlueStack.Outputs.DatabaseName

  BucketName:
    Description: Name of the S3 Bucket
    Value: !GetAtt GlueStack.Outputs.BucketName

  CrawlerName:
    Description: Name of the Glue Crawler
    Value: !GetAtt GlueStack.Outputs.CrawlerName

  # Governance Outputs
  DBAccessScopeTagKey:
    Description: DBAccessScope Tag Key
    Value: !GetAtt GovernanceStack.Outputs.DBAccessScopeTagKey

  PIITagKey:
    Description: PII Tag Key
    Value: !GetAtt GovernanceStack.Outputs.PIITagKey

  # API Outputs
  APIEndpoint:
    Description: API Gateway endpoint URL for Athena queries
    Value: !GetAtt APIStackV2.Outputs.APIEndpoint

  APIEndpointIAM:
    Description: API Gateway endpoint URL for IAM authenticated queries
    Value: !GetAtt APIStackV2.Outputs.APIEndpointIAM

  APIEndpointOAuth:
    Description: API Gateway endpoint URL for OAuth authenticated queries
    Value: !If [EnableOAuthStack, !GetAtt APIStackV2.Outputs.APIEndpointOAuth, "OAuth not enabled"]
    Condition: EnableOAuthStack

  DevUserAPIKey:
    Description: Dev User API Key Value (SENSITIVE - use to query with limited permissions)
    Value: !GetAtt DynamoDBStack.Outputs.DevUserAPIKeyValue

  SuperUserAPIKey:
    Description: Super User API Key Value (SENSITIVE - use to query with full permissions)
    Value: !GetAtt DynamoDBStack.Outputs.SuperUserAPIKeyValue

  # Cognito Outputs (from parameters - deploy Cognito stack separately)
  CognitoUserPoolId:
    Description: Cognito User Pool ID (from parameter)
    Value: !If [EnableOAuthStack, !Ref CognitoUserPoolId, "OAuth not enabled"]
    Condition: EnableOAuthStack

  CognitoAppClientId:
    Description: Cognito App Client ID (from parameter)
    Value: !If [EnableOAuthStack, !Ref CognitoAppClientId, "OAuth not enabled"]
    Condition: EnableOAuthStack

  # Stack References
  IAMStackId:
    Description: IAM Stack ID
    Value: !Ref IAMStack

  GlueStackId:
    Description: Glue Stack ID
    Value: !Ref GlueStack

  GovernanceStackId:
    Description: Governance Stack ID
    Value: !Ref GovernanceStack

  LambdaStackId:
    Description: Lambda Stack ID
    Value: !Ref LambdaStack

  APIStackId:
    Description: API Stack ID
    Value: !Ref APIStackV2

  DynamoDBStackId:
    Description: DynamoDB Stack ID
    Value: !Ref DynamoDBStack
